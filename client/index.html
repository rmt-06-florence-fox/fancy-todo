<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css"
    integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
  <title>Document</title>
</head>



<body>
  <!-- navbar -->
  <div id=navbar-container>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
      <a class="navbar-brand" href="#">Fancy Todo</a>
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
        aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav mr-auto">
          <li class="nav-item active">
            <a class="nav-link" href="" id="home">Home <span class="sr-only">(current)</span></a>
          </li>
        </ul>
        <button class="btn btn-outline-success my-2 my-sm-0" id="sign-out-button" onclick="logout()">Sign Out</button>
      </div>
    </nav>
  </div>
  <div class="container p-5">
    <!-- login -->
    <div id="login-page">

      <form id="login-form">
        <div class="form-group">
          <label for="inputEmail">Email</label>
          <input type="email" id="inputEmail" class="form-control">
        </div>
        <div class="form-group">
          <label for="inputPassword">password</label>
          <input type="password" id="inputPassword" class="form-control">
        </div>
        <input type="submit" id="submit-login" value="login">
      </form>
      <a href="" id="link-register">register</a>

    </div>
    <!-- register -->
    <div id="register-page">
      <form id="register-form">
        <div class="form-group">
          <label for="inputEmail">Email</label>
          <input type="email" id="inputEmailRegister" class="form-control">
        </div>
        <div class="form-group">
          <label for="inputPassword">password</label>
          <input type="password" id="inputPasswordRegister" class="form-control">
        </div>
        <input class="btn btn-primary" type="submit" id="submit-register" value="register">
      </form>

    </div>

    <div id="main-page">
      <div id="create-todo-form">
        <form id="add-form">
          <div class="form-group">
            <label for="inputTittle">Tittle</label>
            <input type="text" id="inputTittle" class="form-control">
          </div>
          <div class="form-group">
            <label for="inputDescription">Description</label>
            <input type="text" id="inputDescription" class="form-control">
          </div>
          <div class="form-group">
            <label for="inputStatus">Status</label>
            <input type="text" id="inputStatus" class="form-control">
          </div>
          <div class="form-group">
            <label for="inputDuedate">Due date</label>
            <input type="date" id="inputDuedate" class="form-control">
          </div>
          <input type="submit" id="submit-add" value="add">
        </form>
      </div>
      <br>
      <div id="list-todo" class="row row-cols-1 row-cols-md-4"></div>

    </div>
    <div id="edit-page"></div>
  </div>






  <script src="http://code.jquery.com/jquery-3.5.1.min.js"
    integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
  <script>
    function hideAll() {
      $('#login-page').hide();
      $('#main-page').hide();
      $('#create-todo').hide();
      $('#sign-out-button').hide();
      $('#register-page').hide();
      $('#edit-page').hide();
    }

    function showLogin() {
      hideAll()
      $('#login-page').show();
    }
    function showMainPage() {
      hideAll();
      $('#main-page').show();
      $('#create-todo').show();
      $('#sign-out-button').show();
      console.log(checkToken());
      fetchAll();
    }
    function showRegister() {
      hideAll();
      $('#register-page').show();
    }

    function showEditForm(data) {
      hideAll();
      $('#sign-out-button').show();

      // console.log(data);
      $('#edit-page').show().empty().append(`
        <form id="edit-form" onsubmit="updateTodo(${data.id})">
          <div class="form-group">
            <label for="editTittle">Tittle</label>
            <input type="text" id="editTittle" class="form-control" value="${data.tittle}">
          </div>
          <div class="form-group">
            <label for="editDescription">Description</label>
            <input type="text" id="editDescription" class="form-control" value="${data.description}">
          </div>
          <div class="form-group">
            <label for="editStatus">Status</label>
            <input type="text" id="editStatus" class="form-control" value="${data.status}">
          </div>
          <div class="form-group">
            <label for="editDuedate">Due date</label>
            <input type="date" id="editDuedate" class="form-control" value="${data.due_date}">
          </div>
          <input type="submit" id="submit-edit" value="edit">
        </form>
      `);
    }

    function login() {

      const email = $('#inputEmail').val()
      const password = $('#inputPassword').val()
      console.log(email, password);

      $.ajax({
        method: "POST",
        url: "http://localhost:3000/login",
        data: {
          email,
          password
        }
      })
        .done((response) => {
          console.log(response);
          localStorage.setItem('access_token', response.access_token)
          console.log(localStorage.getItem('access_token'));
          showMainPage();
        })
        .fail((xhr, textStatus) => {
          console.log(xhr.responseJSON);
        })
        .always(_ => {
          $('#inputEmail').val("")
          $('#inputPassword').val("")
        })
    }

    function logout() {
      console.log("a");
      localStorage.removeItem("access_token");
      showLogin();
    }

    function register() {
      const email = $('#inputEmailRegister').val()
      const password = $('#inputPasswordRegister').val()
      console.log(email, password);
      $.ajax({
        method: "POST",
        url: "http://localhost:3000/register",
        data: {
          email,
          password
        }
      })
        .done(_ => {
          showLogin()
        })
        .fail((xhr, textStatus) => {
          console.log(xhr);
        })
        .always(_ => {
          $('#inputEmailRegister').val("")
          $('#inputPasswordRegister').val("")
        })
    }

    function fetchAll() {
      $.ajax({
        method: "GET",
        url: "http://localhost:3000/todos",
        headers: {
          access_token: localStorage.getItem('access_token')
        }
      })
        .done(todos => {
          $('#list-todo').empty()

          todos.forEach(e => {
            $('#list-todo').append(`
            <div class="col mb-4">
              <div class="card">
                <h5 class="card-header">${e.tittle}</h5>
                <div class="card-body">
                  <h3 class="card-title">status : ${e.status}</h3>
                  <p class="card-text">description : ${e.description}</p>
                  <p class="card-text">due date : ${e.due_date}</p>
                  <a href="#" class="btn btn-primary" onclick = "editTodo(${e.id})">edit</a>
                  <a href="#" class="btn btn-primary" onclick = "deleteTodo(${e.id})">delete</a>
                </div>
              </div>
            </div>
            `)
          });
        })
        .fail((xhr, textStatus) => {
          console.log(xhr, textStatus);
        })
        .always()
    }

    function create() {
      const tittle = $('#inputTittle').val();
      const description = $('#inputDescription').val();
      const status = $('#inputStatus').val();
      const due_date = $('#inputDuedate').val();

      console.log(tittle, description, status, due_date);

      $.ajax({
        method: 'POST',
        url: 'http://localhost:3000/todos',
        headers: {
          access_token: localStorage.getItem('access_token')
        },
        data: {
          tittle,
          description,
          status,
          due_date
        }
      })
        .done(_ => {
          fetchAll();
        })
        .fail((xhr, textStatus) => {
          console.log(xhr, textStatus);
        })
        .always(_ => {
          $('#inputTittle').val("");
          $('#inputDescription').val("");
          $('#inputStatus').val("");
          $('#inputDuedate').val("");
        })
    }

    function deleteTodo(id) {
      console.log(id);
      $.ajax({
        method: 'DELETE',
        url: `http://localhost:3000/todos/${id}`,
        headers: {
          access_token: localStorage.getItem('access_token')
        }
      })
        .done(_ => {
          fetchAll()
        })
        .fail((xhr, textStatus) => {
          console.log(xhr, textStatus);
        })
    }

    function editTodo(id) {
      console.log(id);
      $.ajax({
        method: 'GET',
        url: `http://localhost:3000/todos/${id}`,
        headers: {
          access_token: localStorage.getItem('access_token')
        }
      })
        .done(data => {
          // console.log(data);submit-edit
          showEditForm(data)
        })
        .fail((xhr, textStatus) => {
          console.log(xhr, textStatus);
        })
    }

    function updateTodo(id) {

      const tittle = $('#editTittle').val();
      const description = $('#editDescription').val();
      const status = $('#editStatus').val();
      const due_date = $('#editDuedate').val();
      console.log(id, tittle, description, status, due_date);

      $.ajax({
        method: "PUT",
        url: `http://localhost:3000/todos/${id}`,
        headers: {
          access_token: localStorage.getItem('access_token')
        },
        data: {
          tittle,
          description,
          status,
          due_date
        }
      })
        .done(_ => {
          showMainPage()
        })
        .fail((xhr, textStatus) => {
          console.log(xhr, textStatus);
        })
    }

    function checkToken() {
      if (localStorage.getItem('access_token')) {
        return true
      } else {
        return false
      }
    }

    $(document).ready(() => {
      if (localStorage.getItem('access_token')) {
        showMainPage();
      } else {
        showLogin();
      }

      $('#login-form').on('submit', (e) => {
        e.preventDefault()
        login()
      })

      $('#home').on('click', e => {
        e.preventDefault();
        if (checkToken()) {
          showMainPage()
        } else showLogin()
      })

      $('#link-register').on('click', (e) => {
        e.preventDefault();
        showRegister();
      })

      $('#register-form').on('submit', (e) => {
        e.preventDefault();
        register();
      })

      $('#add-form').on('submit', (e) => {
        e.preventDefault();
        create();
      })


    })
  </script>
</body>

</html>