<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google-signin-client_id" content="135754795964-jgcilhhb0p1j7cttojsh8oi5vaoa87cc.apps.googleusercontent.com">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
    <title>fancy~todo</title>
  </head>
  <body>
    <!-- In Session Navbar -->
    <nav
      class="navbar fixed-top navbar-expand-lg navbar-dark bg-dark"
      id="in-session-nav"
    >
      <a class="navbar-brand" href="" onclick="showMainPage(event)"
        >fancy~todo</a
      >
        <ul class="navbar-nav ml-auto">
          <li class="nav-item">
            <a
              class="nav-link font-weight-bold"
              href=""
              onclick="logout(event)"
              >Sign Out</a
            >
          </li>
        </ul>
      </div>
    </nav>
    <!-- End In Session Navbar -->
    <!-- login-page -->
    <!-- video bg -->
    <div id="bg-video">
      <div class="bg-video">
          <video class="bg-video-content" autoplay muted loop>
              <source src="assets/video.mp4" type="video/mp4">
                  not supported
              </video>
          </div>
      </div>
    <div id="login-page" class="login-page">
      <div class="jumbotron jumbotron-fluid">
        <div class="container d-flex justify-content-center">
          <!-- Sign In Form -->
          <div class="w-100 d-flex justify-content-center align-items-center">
            <div class="card shadow mb-5">
              <form class="card-body" id="login-form">
                <div class="form-group mb-4">
                  <h2>Login</h2>
                  <label for="login-email">Username or Email</label>
                  <input
                    type="text"
                    class="form-control"
                    id="login-email"
                    required
                  />
                </div>
                <div class="form-group mb-4">
                  <label for="password">Password</label>
                  <input
                    type="password"
                    class="form-control"
                    id="login-password"
                    required
                  />
                </div>
                <div class="d-inline-flex align-items-center">
                  <button type="submit" class="btn btn-primary">Sign In</button>
                  <span class="mx-3">Or</span>
                  <div
                    class="g-signin2 d-inline-block"
                    data-onsuccess="onSignIn"
                  ></div>
                </div>
                <div class="text-right" >
                  <small>
                    <a href="" id="link-register">Don't have an account?</a
                    >
                  </small>
                </div>
              </form>
            </div>
          </div>
        </div>
          <!-- end login-page -->
        </div>
      </div>
    </div>

    <!-- register-page -->
    <!-- Sign Up Page -->
    <div class="page" id="register-page">
      <div class="jumbotron jumbotron-fluid">
        <div class="container d-flex justify-content-center">
          <!-- Sign Up Form -->
          <div class="w-100 d-flex justify-content-center align-items-center">
            <div class="card shadow mb-5">
              <form id="register-form" class="card-body">
                <h1>Sign Up</h1>
                <div class="form-group">
                  <label for="username">Username</label>
                  <input
                    type="text"
                    class="form-control"
                    id="register-username"
                    required
                  />
                  <small class="form-text text-muted"
                    >usernamenya yang keren dikit</small
                  >
                </div>
                <div class="form-group">
                  <label for="email">Email</label>
                  <input
                    type="email"
                    class="form-control"
                    id="register-email"
                    required
                  />
                  <small class="form-text text-muted"
                    >email yang bener</small
                  >
                </div>
                <div class="form-group">
                  <label for="password">Password</label>
                  <input
                    type="password"
                    class="form-control"
                    id="register-password"
                    required
                  />
                  <small class="form-text text-muted"
                    >passwordnya yang susah ditebak</small
                  >
                </div>
                <div class="d-inline-flex align-items-center">
                  <button type="submit" class="btn btn-primary">Sign Up</button>
                  <span class="mx-3">Or</span>
                  <div
                    class="g-signin2 d-inline-block"
                    data-onsuccess="checkSession"
                  ></div>
                </div>
                <div href="" class="text-right">
                  <a href=""  id="link-login"><small>
                      >Already have account?</a
                    >
                  </small></a>
                </div>
              </form>
            </div>
          </div>
        </div>
        <!-- end register-page -->
        </div>
      </div>

    <!-- main-page -->
    <div class="container p-5"></div>
      <div id="main-page" class="main-page" style="margin-top: 6em;">
        <div class="container d-flex justify-content-center">
          <div class="w-100 d-flex justify-content-center align-items-center">
            <div class="card shadow mb-5">
              <form id="add-form" class="card-body">
                <div class="form-group">
                  <label for="input-title">title</label>
                  <input
                  type="text"
                  id="input-title"
                  class="form-control"
                  required>
                  <small>kamu mau ngapain</small>
                </div>
                <div class="form-group">
                  <label for="input-description">description</label>
                  <input
                  type="text"
                  id="input-description"
                  class="form-control"
                  required>
                  <small>kasih deskripsi dong</small>
                </div>
                <div class="form-group">
                  <label for="input-due_date">due date</label>
                  <input
                  type="date"
                  id="input-due_date"
                  class="form-control"
                  required>
                  <small>deadlinenya kapan? gaboleh hari ini</small>
                </div>
                <input type="submit" id="submit-add" value="add">
              </form>
            </div>
          </div>
        </div>
    
        <br>
        <div id="list-todo" class="row row-cols-1 row-cols-sm-4"></div>
      </div>
    </div>
    <div cass="container p-5">
      <div id="edit-page"></div>
    </div>
    <!-- end main-page -->
    
    <!-- SCRIPT SCRIPT -->
    <script src="./js/main.js"></script>
    <script src="https://apis.google.com/js/platform.js" async defer></script>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
    
    <!-- page handler -->
    <script>
      const URL = "http://localhost:3000/"
      //hidesemua
      function hideAll() {
        $('#in-session-nav').hide()
        $('#login-page').hide()
        $('#register-page').hide()
        $('#main-page').hide()
        $('#create-todo').hide()
        $('#edit-page').hide()
      }

      //login
      function showLogin() {
        hideAll()
        $('#login-page').show()
      }

      function login() {
        const email = $('#login-email').val()
        const password = $('#login-password').val()
        $.ajax({
          method: 'POST',
          url: "http://localhost:3000/login",
          data: {
            email, password
          }
        })
        .done((response) => {
          localStorage.setItem('access_token', response.access_token)
          console.log(response.access_token)
          showMainPage()
        })
        .fail((xhr) => {
          console.log(xhr.responseJSON)
        })
        .always(_ => {
          $('#login-page').trigger('reset')
        })
      }

      //login google
      function onSignIn(googleUser) {
      var id_token = googleUser.getAuthResponse().id_token;
      console.log(id_token);
      $.ajax({
        url: 'http://localhost:3000/loginGoogle',
        method: 'POST',
        data: {
          googleToken: id_token
        }
      })
        .done(response => {
          localStorage.setItem('access_token', response.access_token)
          showMainPage();
        })
        .fail((xhr, textStatus) => {
          console.log(xhr, textStatus);
        })
    }

    // register
      function showRegister(e) {
        hideAll()
        $('#register-page').show()
      }

      function register() {
        const username = $('#register-username').val()
        const email = $('#register-email').val()
        const password = $('#register-password').val()

        $.ajax({
          method: 'POST',
          url: "http://localhost:3000/register",
          data: {
            username, email, password
          }
        })
        .done((response) => {
          showLogin()
        })
        .fail((xhr) => {
          console.log(xhr.responseJSON)
        })
        .always(_ => {
          $('#register-page').trigger('reset')
        })
      }
    
      // logout
      function logout(e) {
        e.preventDefault()
        localStorage.removeItem('access_token')
        var auth2 = gapi.auth2.getAuthInstance()
        auth2.signOut().then(function() {
          console.log('User signed out.')
        })
        showLogin()
      }

      //liatin mainpage
      function showMainPage() {
        hideAll()
        $('#in-session-nav').show()
        $('#main-page').show()
        $('#list-todo').show()
        $('#create-todo').show()
        fetchAll()
      }

      //edit Form
      function showEditForm(data) {
        hideAll()
        $('#edit-page').show().empty().append(`
        <div class="container d-flex justify-content-center">
          <div class="w-100 d-flex justify-content-center align-items-center">
            <div class="card shadow mb-5">
              <form id="edit-form" class="card-body" onsubmit="updateTodo(${data.id})">
                <div class="form-group">
                  <label for="edit-title">title</label>
                  <input
                  type="text"
                  id="edit-title"
                  class="form-control"
                  value="${data.title}"
                  required>
                  <small>kamu mau ngapain</small>
                </div>
                <div class="form-group">
                  <label for="edit-description">description</label>
                  <input
                  type="text"
                  id="edit-description"
                  class="form-control"
                  value="${data.description}"
                  required>
                  <small>kasih deskripsi dong</small>
                </div>
                <div class="form-group">
                  <label for="input-due_date">due date</label>
                  <input
                  type="date"
                  id="edit-due_date"
                  class="form-control"
                  value="${data.due_date}"
                  required>
                  <small>deadlinenya kapan? gaboleh hari ini</small>
                </div>
                <input type="submit" id="submit-add" value="add">
              </form>
            </div>
          </div>
        </div>
        `)
      }
      function updateTodo(id) {
        const title = $('#edit-title').val()
        const description = $('#edit-description').val()
        const due_date = $('#edit-due_date').val()

        $.ajax({
          method: 'PUT',
          url: `http://localhost:3000/todos/${id}`,
          headers: {
            access_token: localStorage.getItem('access_token')
          },
          data: {
            title, description, due_date
          }
        })
        .done(_=> {
          showMainPage()
        })
        .fail(xhr => {
          console.log(xhr)
        })
      }

      //CRUD
      //create
      function create() {
        const title = $('#input-title').val()
        const description = $('#input-description').val()
        const due_date = $('#input-due_date').val()

        console.log(title, description, due_date)

        $.ajax({
          method: 'POST',
          url: "http://localhost:3000/todos",
          headers: {
            access_token: localStorage.getItem('access_token')
          },
          data: {
            title, description, due_date
          }
        })
        .done(_ => {
          fetchAll()
        })
        .fail((xhr, text) => {
          console.log(xhr, text)
        })
        .always(_ => {
          $('#add-form').trigger('reset')
        })
      }

      //read
      //fetchAll
      function fetchAll() {
      $.ajax({
        method: "GET",
        url: "http://localhost:3000/todos",
        headers: {
          access_token: localStorage.getItem('access_token')
        }
      })
        .done(todos => {
          $('#list-todo').empty()
          todos.forEach(e => {
            $('#list-todo').append(`
            <div class="w-100 d-flex justify-content-center align-items-center">
              <div class="col md-4">
                <div class="card shadow mb-5">
                  <h5 class="card-header">${e.title} <a href="#" class="btn btn-primary" onclick = "deleteTodo(${e.id})">✕</a> </h5>
                  <div class="card-body">
                    <small>status</small>
                    <h3 class="card-title">${e.status}</h3>
                    <small>description</small>
                    <p class="card-text">${e.description}</p>
                    <small>due date</small>
                    <p class="card-text">${e.due_date}</p>
                    <a href="#" class="btn btn-primary" onclick = "editTodo(${e.id})">✏</a>
                    <a href="#" class="btn btn-primary" onclick = "doneTodo(${e.id})">✔</a>
                  </div>
                </div>
              </div>
            </div>
            `)
          });
        })
        .fail((xhr, textStatus) => {
          console.log(xhr, textStatus);
        })
        .always()
      }

      
      //update
      function editTodo(id) {
        $.ajax({
          method: 'GET',
          url: `http://localhost:3000/todos/${id}`,
          headers: {
            access_token: localStorage.getItem('access_token')
          }
        })
        .done(data => {
          showEditForm(data)
        })
        .fail(xhr => {
          console.log(xhr)
        })
      }

      function doneTodo(id) {
        $.ajax({
          method: "PATCH",
          url: `http://localhost:3000/todos/${id}`,
          headers: {
            access_token: localStorage.getItem('access_token')
          },
          data: {
            status: `completed ✔`
          }
        })
        .done(_ => {
          showMainPage()
        })
        .fail(xhr => {
          console.log(xhr)
        })
      }
      
      //delete
      function deleteTodo(id) {
        console.log(id)
        $.ajax({
          method: "DELETE",
          url: `http://localhost:3000/todos/${id}`,
          headers: {
            access_token: localStorage.getItem('access_token')
          }
        })  
        .done(_ => {
          fetchAll()
        })
        .fail((xhr, text) => {
          console.log(xhr, text)
        })
      }

      //document ready sob
      $(document).ready(() => {
        if (localStorage.getItem("access_token")) {
          showMainPage()
        } else {
          showLogin()
        }
        //ketika hit submit form di login
        $('#login-form').on('submit', (e) => {
          e.preventDefault()
          login()
        })
        //redirect register ke login
        $('#link-login').on('click', (e) => {
          e.preventDefault();
          showLogin()
        })
        //redirect login ke register
        $('#link-register').on('click', (e) => {
          e.preventDefault();
          showRegister()
        })
        //hit submit form di register
        $('#register-form').on('submit', (e) => {
          e.preventDefault()
          register()
        })

        //CRUD
        //add-form
        $('#add-form').on('submit', (e) => {
          e.preventDefault();
          create()
        })


      })
    </script>
    <!-- END SCRIPT SCRIPT -->
  </body>
</html>
