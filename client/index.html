<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>fancy-todo</title>
</head>
<body>
    <button id="logout-btn">Log Out</button>
    <button id="register-btn">Register</button>
    <div id="login-form">
        <form action="">
            <h1>Login Form</h1>
            <label for="email">Email</label><br>
            <input type="text" name="email" id="email-input"><br>
            <label for="password">Password</label><br>
            <input type="text" name="password" id="password-input"><br>
            <button type="submit">Submit</button>
        </form>
    </div>
    <div id="register-form">
        <form action="">
            <h1>Register</h1>
            <label for="first_name">first_name</label><br>
            <input type="text" name="first_name" id="create-first_name"><br>
            <label for="last_name">last_name</label><br>
            <input type="text" name="last_name" id="create-last_name"><br>
            <label for="email">Email</label><br>
            <input type="text" name="email" id="create-email"><br>
            <label for="password">Password</label><br>
            <input type="text" name="password" id="create-password"><br>
            <button type="submit">Submit</button>
        </form>
    </div>
    <div id="add-form">
        <form action="">
            <h1>Add Todo</h1>
            <label for="title">title</label><br>
            <input type="text" name="title" id="add-title"><br>
            <label for="description">description</label><br>
            <input type="text" name="description" id="add-description"><br>
            <label for="status">status</label><br>
            <input type="text" name="status" id="add-status"><br>
            <label for="due_date">due_date</label><br>
            <input type="text" name="due_date" id="add-due_date"><br>
            <button type="submit">Submit</button>
        </form>
    </div>
    <div id="edit-form">
        <form action="">
            <h1>Edit Todo</h1>
            <label for="edit-title">title</label><br>
            <input type="text" name="edit-title" id="edit-title"><br>
            <label for="edit-description">description</label><br>
            <input type="text" name="edit-description" id="edit-description"><br>
            <label for="edit-status">status</label><br>
            <input type="text" name="edit-status" id="edit-status"><br>
            <label for="edit-due_date">due_date</label><br>
            <input type="text" name="edit-due_date" id="edit-due_date"><br>
            <button type="submit">Submit</button>
        </form>
    </div>
    <div id="list-todo">
        <table border="1" style="width: 80%;">
            <thead>
                <tr>
                    <td style="width:20%;">Title</td>
                    <td style="width:20%;">Description</td>
                    <td style="width:20%;">Status</td>
                    <td style="width:20%;">Due Date</td>
                    <td style="width:20%;">Action</td>
                </tr>
            </thead>
        </table>
    </div>
<script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
<script>
    function showLoginPage(){
        $("#logout-btn").hide()
        $("#register-btn").show()
        $("#login-form").show()
        $("#register-form").hide()
        $("#add-form").hide()
        $("#edit-form").hide()
        $("#list-todo").hide()
    }
    function login(){
        const email = $("#email-input").val()
        const password = $("#password-input").val()
        //perlu masuk server ke routes login
        $.ajax({
            url: 'http://localhost:3000/login',
            method: 'POST',
            data:{
                email,
                password
            }
        })
        .done(response=>{
            showLoginPage()
            localStorage.setItem('access_token', response.access_token)
        })
        .fail(xhr=>{
            console.log(xhr)
        })
        .always(function(){
            $("#email-input").val("")
            $("#password-input").val("")
        })
    }
    function showRegisterPage(){
        $("#logout-btn").hide()
        $("#register-btn").hide()
        $("#login-form").hide()
        $("#register-form").show()
        $("#add-form").hide()
        $("#edit-form").hide()
        $("#list-todo").hide()
    }
    function showMainPage(){
        $("#logout-btn").show()
        $("#register-btn").hide()
        $("#login-form").hide()
        $("#register-form").hide()
        $("#add-form").show()
        $("#edit-form").hide()
        $("#list-todo").show()
        fetchTodos()
    }
    function showEditPage(data){
        $("#logout-btn").show()
        $("#register-btn").hide()
        $("#login-form").hide()
        $("#register-form").hide()
        $("#add-form").hide()
        $("#edit-form").show()
        $("#list-todo").hide()
        editTodo(data)
    }
    function logout(){
        localStorage.clear()
        showLoginPage()
    }
    function fetchTodos(){
        $.ajax({
            method: "GET",
            url: "http://localhost:3000/todos",
            headers: {
                access_token: localStorage.getItem('access_token')
            }
        })
        .done(response=>{
            $("#list-todo").empty()
            console.log(response)
            response.forEach(todo=>{
                $("#list-todo").append(`
                <table border="1" style="width: 80%;">
                    <tr>
                    <td style="width:20%;">${todo.title}</td>
                    <td style="width:20%;">${todo.description}</td>
                    <td style="width:20%;">${todo.status}</td>
                    <td style="width:20%;">${todo.due_date}</td>
                    <td style="width:20%;"><a onclick="showEditPage(${todo.id})">Edit</a> || <a onclick="deleteTodo(${todo.id})">Delete</a></td>
                    </tr>
                </table>
                `)
            })
        })
        .fail(xhr=>{
            // console.log('theres error')
            console.log(xhr)
        })
    }
    function addTodos(){
        const title = $("#add-title").val()
        const description = $("#add-description").val()
        const status = $("#add-status").val()
        const due_date = $("#add-due_date").val()
        // console.log(title, description, status, due_date)
        $.ajax({
            method: 'POST',
            url: "http://localhost:3000/todos",
            headers: {
                access_token: localStorage.getItem('access_token')
            },
            data: {
                title,
                description,
                status,
                due_date
            }
        })
        .done(response => {
            console.log(response)
        })
        .fail(xhr=>{
            console.log(xhr)
        })
    }
    function newRegister(){
        const first_name = $("#create-first_name").val()
        const last_name = $("#create-last_name").val()
        const email = $("#create-email").val()
        const password = $("#create-password").val()
        $.ajax({
            method: 'POST',
            url: "http://localhost:3000/register",
            data: {
                first_name,
                last_name,
                email,
                password
            }
        })
        // console.log(first_name, last_name, email, password)
        .done(response=>{
            console.log(response)
            showLoginPage()
        })
        .fail(xhr=>{
            console.log('error')
        })
    }
    function deleteTodo(data){
        $.ajax({
            method: 'DELETE',
            url: `http://localhost:3000/todos/${data}`,
            headers:{
                access_token: localStorage.getItem('access_token')
            }
        })
        .done(response=>{
            showMainPage()
        })
        .fail(xhr=>{
            console.log(xhr)
        })
    }
    function editTodo(data){
        $.ajax({
            method: 'GET',
            url: `http://localhost/todos/${data}`,
            headers: {
                access_token: localStorage.getItem('access_token')
            }
        })
        .done(response=>{
            // console.log(response)
            $("#edit-title").val(response.title)
            $("#edit-description").val(response.description)
            $("#edit-status").val(response.status)
            $("#edit-due_date").val(response.due_date)
            editData(data)
        })
        .fail(xhr=>{
            console.log(xhr)
        })
    }
    function editData(data){
        const title = $("#edit-title").val()
        const description = $("#edit-description").val()
        const status = $("#edit-status").val()
        const due_date = $("#edit-due_date").val()
        console.log(title, description, status, due_date)
        $.ajax({
            method: 'PUT',
            url: `http://localhost/todos/${data}`,
            headers: {
                access_token: localStorage.getItem('access_token')
            },
            data:{
                title,
                description,
                status,
                due_date
            }
        })
        .done(response=>{
            console.log(response)
        })
        .fail(xhr=>{
            console.log(xhr)
        })
    }
    $(document).ready(function(){
        if(localStorage.getItem('access_token')){
            showMainPage()
        } else {
            showLoginPage()
        }
        $("#login-form").on("submit", function(e){
            e.preventDefault()
            login()
        })
        $("#logout-btn").on("click", function(){
            logout()
        })
        $("#add-form").on("submit", function(e){
            e.preventDefault()
            addTodos()
        })
        $("#register-btn").on("click", function(){
            showRegisterPage()
        })
        $("#register-form").on("submit", function(e){
            e.preventDefault()
            newRegister()
        })
        $("#edit-form").on("submit", function(e){
            e.preventDefault
        })
    })
</script>
</body>
</html>