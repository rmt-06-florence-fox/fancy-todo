<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="google-signin-client_id"
        content="178899368312-1ildcs0f3or5vto3bdcbv2nsh84pigto.apps.googleusercontent.com">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css"
        integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css">
</head>

<body>

  <div id="login-page">
    <form id="login-form">
      <section id="landing" class="container">
       
        <div class="row justify-content-center mt-5">
            <div class="col-4">
                <form onsubmit="login(event)">
                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" name="email" id="email" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="password">Password</label>
                        <input type="password" name="password" id="password" class="form-control">
                    </div>
                    <button type="submit " class="btn btn-primary">Login</button>
                </form>
            </div>
        </div>
    </section>
    </form>
  
 
  </div> <br><br>



 

    <div id="edit">
      
    </div>
  <!-- adding -->
  <button id= "btn-logout" class="btn btn-danger" onclick="logout()">Logout</button>
  <div >
        <form id="form-add">
          <div class="col-6 mt-4">
            <p>Form Add ToDo</p>
          <div class="d-flex justify-content-center align-items-center" style="height: 100vh;">
          <div class="p-5 bg-light shadow" style="width: 100%; height: 80%; border-radius: 10px;">
          <div class="form-group">
            <label for="title">Title</label>
            <input type="text" id="add-title" class="form-control">
          </div>
          <div class="form-group">
            <label for="description">Description</label>
            <input type="text" id="add-description" class="form-control">
          </div>
          <div class="form-group">
            <label for="status">Status</label>
            <input type="text" id="add-status" class="form-control">
          </div>
          <div class="form-group">
            <label for="due_date">Due date</label>
            <input type="date" id="add-due_date" class="form-control">
          </div>
          <input type="submit" id="submit-add" value="add">
          </div>
          </div>
       
        </form>
    </div>
<!-- list-todos -->
    <section id="content" class="container-fluid" >
    <div class="col-60 mt-4">
      <div id="list-todos"></div>
    </div>
  </section> 



      

  <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
  <script>
    function hide(){

    }
    function showlogin () {
      $("#login-page").show()
      $("#form-add").hide()
      $("#showMainPage").hide()
      $("#showEditPage ").hide()
      $("#btn-logout").hide()

    }
    function showMainPage (){
      $("#form-add").show()
      $("#login-page").hide()
      $("#showEditPage").hide()
      $("#btn-logout").show()
      fetchData()
    }

    function showEditPage (){
      $("#showEditForm").show()
      $("#edit").show()
      $("#form-add").hide()
      $("#fetchData").hide()
      $("#btn-logout").show()
     
    }
    function login (){
        const email = $("#email").val()
        const password = $("#password").val()
        console.log(email,password)
        $.ajax({
          
          url: "http://localhost:3000/login",
          method: "POST",
          data: { 
            email,
            password}
        })
        .done(response => {
          localStorage.setItem('access_token',response.access_token)
          console.log(response)
          showMainPage()
        })
        .fail((xHR, textStatus)  => {
          console.log(  xHR,textStatus );
        })
        .always(()=>{
          $("#email").val()
          $("#password").val()


        })
      
    }

    function logout (){
      localStorage.clear()
      showlogin()
    }
    function deleteTodo(id){
      console.log(id);
      $.ajax({
        method : 'DELETE',
        url : `http://localhost:3000/todos/${id}`,
        headers:{
          access_token: localStorage.getItem('access_token')
        }
      })
      .done(_=>{
        showMainPage()
      })
      .fail((xhr, textStatus)=>{
        console.log(xhr, textStatus);
      })

    }

    function addTodo(){
    console.log('masuk add todo');

     let title = $('#add-title').val();
      let description = $('#add-description').val();
      let status = $('#add-status').val();
      let due_date = $('#add-due_date').val();

     

      $.ajax({
        method :'POST',
        url : 'http://localhost:3000/todos',
        headers:{
          access_token: localStorage.getItem('access_token')
        },
        data:{
          title,
          description,
          status,
          due_date
        }
      })
      .done(response=>{
        console.log(response)
        fetchData()
      })
      .fail((xhr,textStatus)=>{
        console.log(xhr,textStatus);
      })
      .always(_=>{
        $('#add-title').val("");
        $('#add-description').val("");
        $('#add-status').val("");
        $('#add-due_date').val("");
      })
    }
    function fetchData(){
      $.ajax({
          method: "GET",
          url: "http://localhost:3000/todos",
          headers: {
            access_token: localStorage.getItem('access_token')
          }
          
        })
        .done(response => {
       
        const todos = response
       
        $("#title-todo").show()
        $("#list-todos").empty()

        response.forEach(el => {

            $("#list-todos").append(`
            
                <div class="col-4 mb-5 md-3">
                  
                    <p> title: ${el.title}</p>
                    <p> description: ${el.description}</p>
                   <p>  status: ${el.status}</p>
                   <p>  due date: ${el.due_date}</p>
                    <button type="submit" class="btn btn-primary" style="background-color: green;" onClick="getEdit(${el.id},'${el.title}','${el.description}','${el.status}','${el.due_date}')">Edit</button>
                    <button type="submit" class="btn btn-primary" style="background-color: red;" onClick="deleteTodo(${el.id})">Delete</button>
                </div>
            `)
        })
        // console.log(response, '<< response ')
     
        })
        .fail((xHR, textStatus)  => {
          console.log(  xHR,textStatus );
        })
        .always(()=>{
         


        })
    }
    function showEditForm(data) {
      console.log(data);
      $('#edit').show().empty().append(`
        <form id="edit-form" onsubmit="postEdit(${data.id})">
        <h3>EDIT YOUR TODO LIST!</h3>
            <form >
            <div class="form-group">
                <label >Title</label><br>
                <input class="form-control" type="text" id="edit-title" name="title" value= "${data.title}"><br>
                <label for="description">Description</label><br>
                <input class="form-control" type="text" id="edit-description" name="description" value= "${data.description}">
                <label  for="status">Status</label><br>
                <input class="form-control" type="text" id="edit-status" name="status"value= "${data.status}"><br>
                <label  for="due_date">Due Date</label><br>
                <input class="form-control" type="date" id="edit-due_date" name="due_date" value= "${data.due_date}"><br>
                <br>
                <br>
                <input type="submit" id="submit-edit" value="edit">
                <br>
                </div>
            </form>          
        </div> 

          
        </form>
      `);
    }

    function getEdit(id) {

      $.ajax({
        method: 'GET',
        url: `http://localhost:3000/todos/${id}`,
        headers: {
          access_token: localStorage.getItem('access_token')
        }
      })
        .done(data => {
          showEditForm(data)
        })
        .fail((xhr, textStatus) => {
          console.log(xhr, textStatus);
        })
    }

    function postEdit(id) {

      const title = $('#edit-title').val();
      const description = $('#edit-description').val();
      const status = $('#edit-status').val();
      const due_date = $('#edit-due_date').val();
      console.log(id, title, description, status, due_date);

      $.ajax({
        method: "PUT",
        url: `http://localhost:3000/todos/${id}`,
        headers: {
          access_token: localStorage.getItem('access_token')
        },
        data: {
          title,
          description,
          status,
          due_date
        }
      })
        .done(_ => {
          showMainPage()
        })
        .fail((xhr, textStatus) => {
          console.log(xhr, textStatus);
        })
    }

    
    





     $(document).ready(function(){
       if (localStorage.getItem('access_token')){
         showMainPage()
         
       }
       else {
        showlogin ()
       }
       $("#form-add").on("submit",function(e){
        e.preventDefault();
       addTodo()
  
       })
       $("#login-form").on("submit",function(e){
        e.preventDefault()
        login()
      })
      $("#btn-logout").on("click",function(e){
        e.preventDefault()
        logout()
      })

      
  });
  </script>
</body>
</html>